<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18: http://docutils.sourceforge.net/" />

  <meta property="og:title" content="State-Space Controller Walkthrough" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://docs.wpilib.org/en/stable/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.html" />
  <meta property="og:site_name" content="FIRST Robotics Competition Documentation" />
  <meta property="og:description" content="The goal of this tutorial is to provide “end-to-end” instructions on implementing a state-space controller for a flywheel. By following this tutorial, readers will learn how to: Create an accurate ..." />
  <meta property="og:image" content="https://raw.githubusercontent.com/wpilibsuite/branding/main/png/wpilib-128.png" />
  <meta property="og:image:alt" content="FIRST Robotics Competition Documentation" />
  <meta property="og:ignore_canonical" content="true" />
<meta name="theme-color" content="#003974" />
<meta name="google-site-verification" content="xcmdxM0KzMYiAOeJzyF_l2Tn3AHGzPICs9_vX6q2nwM" />
<link rel="alternate" hreflang="en" href="https://docs.wpilib.org/en/stable/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.html" />
<link rel="alternate" hreflang="x-default" href="https://docs.wpilib.org/en/stable/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.html" />
<link rel="alternate" hreflang="es" href="https://docs.wpilib.org/es/stable/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.html" />
<link rel="alternate" hreflang="fr" href="https://docs.wpilib.org/fr/stable/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.html" />
<link rel="alternate" hreflang="he" href="https://docs.wpilib.org/he/stable/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.html" />
<link rel="alternate" hreflang="pt" href="https://docs.wpilib.org/pt/stable/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.html" />
<link rel="alternate" hreflang="tr" href="https://docs.wpilib.org/tr/stable/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.html" />
<link rel="alternate" hreflang="zh-CN" href="https://docs.wpilib.org/zh_CN/stable/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>State-Space Controller Walkthrough &mdash; FIRST Robotics Competition  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/tooltipster.custom.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/tooltipster.bundle.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-shadow.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-punk.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-noir.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-light.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-borderless.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/micromodal.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/pid-tune.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/frc-rtd.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/sphinx_rtd_theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../_static/FIRSTicon_RGB_withTM.ico"/>
    <link rel="canonical" href="https://docs.wpilib.org/en/stable/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.html" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
        <script async="async" src="../../../../_static/js/present.js"></script>
        <script src="../../../../_static/js/hoverxref.js"></script>
        <script src="../../../../_static/js/tooltipster.bundle.min.js"></script>
        <script src="../../../../_static/js/micromodal.min.js"></script>
        <script src="../../../../_static/js/versionwarning.js"></script>
        <script src="../../../../_static/pid-tune.js"></script>
        <script src="../../../../_static/js/api-docs-redirect.js"></script>
        <script src="../../../../_static/js/fix-rtd-menu-ios.js"></script>
        <script src="../../../../_static/js/external-links-new-tab.js"></script>
        <script src="../../../../_static/js/version-2014.js"></script>
        <script src="../../../../_static/tabs.js"></script>
        <script src="../../../../_static/design-tabs.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="State Observers and Kalman Filters" href="state-space-observers.html" />
    <link rel="prev" title="Introduction to State-Space Control" href="state-space-intro.html" /> 
</head>

<body class="wy-body-for-nav"> 


<div class="header-bar">
        <!-- Color Strip -->
        <div class="color-strip">
            <div class="fred"></div>
            <div class="forange"></div>
            <div class="fblue"></div>
        </div>
        <div class="link-bar-container">
            <div id="link-bar" class="collapse">
                <ul>          
                  <li id="manual-link"><a href="https://www.firstinspires.org/resource-library/frc/competition-manual-qa-system">FRC Game Manual</a></li>
                  <li id="qa-link"><a href="https://frc-qa.firstinspires.org/">FRC Game Q&A</a></li>
                  <script id="headerscript">
                    if( new Date().getMonth() == 3 && new Date().getDate() == 1) {
                      document.getElementById("headerscript").insertAdjacentHTML("afterend", '<li id="water-link"><a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">Water Game</a></li>');
                    }
                  </script>
                </ul>
            </div>
        </div>
</div>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  <a href="../../../../index.html" style="display: block; margin-bottom: 0;">
      FIRST Robotics Competition
    <picture>
      <source
        sizes="300px"
        srcset="../../../../_static/wpilibDocsLogo_300.webp 300w, ../../../../_static/wpilibDocsLogo_500.webp 500w, ../../../../_static/wpilibDocsLogo_700.webp 700w, ../../../../_static/wpilibDocsLogo_1050.webp 1050w"
        type="image/webp"
      />
      <img
        src="../../../../_static/wpilibDocsLogo.png"
        sizes="300px"
        srcset="../../../../_static/wpilibDocsLogo_300.png 300w, ../../../../_static/wpilibDocsLogo_500.png 500w, ../../../../_static/wpilibDocsLogo_700.png 700w, ../../../../_static/wpilibDocsLogo_1050.png 1050w"
        height="468"
        width="1050"
        alt="Logo"
        decoding="async"
        class="logo"
        style="height: auto; width: 100%; border-radius: 0%;"
      />
    </picture>
  </a>
      <div class="version">
        latest
      </div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Zero to Robot</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../zero-to-robot/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zero-to-robot/step-1/index.html">Step 1: Building your Robot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zero-to-robot/step-2/index.html">Step 2: Installing Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zero-to-robot/step-3/index.html">Step 3: Preparing Your Robot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zero-to-robot/step-4/index.html">Step 4: Programming your Robot</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Control System Overviews</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../controls-overviews/control-system-hardware.html">Hardware Component Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../controls-overviews/control-system-software.html">Software Component Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Programming Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../what-is-wpilib.html">What is WPILib?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yearly-overview/index.html">2023 Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vscode-overview/index.html">VS Code Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dashboards/index.html">Dashboards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../telemetry/index.html">Telemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../labview/index.html">FRC LabVIEW Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware-apis/index.html">Hardware APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../can-devices/index.html">CAN Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic-programming/index.html">Basic Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../support/support-resources.html">Support Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../frc-glossary.html">FRC Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.wpilib.org/allwpilib/docs/release/java/index.html">WPILib Java API Docs</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.wpilib.org/allwpilib/docs/release/cpp/index.html">WPILib C++ API Docs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../driverstation/index.html">Driver Station</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wpilib-tools/robotbuilder/index.html">RobotBuilder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wpilib-tools/robot-simulation/index.html">Robot Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wpilib-tools/outlineviewer/index.html">OutlineViewer</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Programming</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../vision-processing/index.html">Vision Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../commandbased/index.html">Command-Based Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kinematics-and-odometry/index.html">Kinematics and Odometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networktables/index.html">NetworkTables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pathplanning/index.html">Path Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roborio-info/index.html">roboRIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced-gradlerio/index.html">Advanced GradleRIO</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Advanced Controls</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../video-walkthrough.html">A Video Walkthrough of Model Based Validation of Autonomous in FRC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html">Advanced Controls Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filters/index.html">Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geometry/index.html">Geometry Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/index.html">Controllers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../trajectories/index.html">Trajectory Generation and Following with WPILib</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">State-Space and Model Based Control with WPILib</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="state-space-intro.html">Introduction to State-Space Control</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">State-Space Controller Walkthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="state-space-observers.html">State Observers and Kalman Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="state-space-pose-estimators.html">Pose Estimators</a></li>
<li class="toctree-l3"><a class="reference internal" href="state-space-debugging.html">Debugging State-Space Models and Controllers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../controls-glossary.html">Controls Glossary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../convenience-features/index.html">Convenience Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples and Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples-tutorials/wpilib-examples.html">WPILib Example Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples-tutorials/third-party-examples.html">Third Party Example Projects</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware/hardware-basics/index.html">Hardware - Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware/hardware-tutorials/index.html">Hardware Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware/sensors/index.html">Sensors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Romi Robot</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../romi-robot/index.html">Getting Started with Romi</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Robot Networking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../networking/networking-introduction/index.html">Networking Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking/networking-utilities/index.html">Networking Utilities</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/frc-docs/index.html">Contributing to frc-docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/wpilib/index.html">Developing with allwpilib</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Issues</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/wpilibsuite/frc-docs/issues">Report an Issue</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">FIRST Robotics Competition</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Advanced Controls</a></li>
          <li class="breadcrumb-item"><a href="index.html">State-Space and Model Based Control with WPILib</a></li>
      <li class="breadcrumb-item active">State-Space Controller Walkthrough</li>
<li class="wy-breadcrumbs-aside" style="padding-inline-start: 6px;">
    <a href="?present" class="btn" style="background-color: #2980b9; color: white; padding: 5px">
        Present
        <span class="fa fa-expand"></span>
    </a>
</li>

      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/wpilibsuite/frc-docs/blob/main/source/docs/software/advanced-controls/state-space/state-space-flywheel-walkthrough.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="state-space-controller-walkthrough">
<h1>State-Space Controller Walkthrough<a class="headerlink" href="#state-space-controller-walkthrough" title="Permalink to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before following this tutorial, readers are recommended to have read an <a class="reference internal" href="state-space-intro.html#introduction-to-state-space-control"><span class="std std-ref">Introduction to State-Space Control</span></a>.</p>
</div>
<p>The goal of this tutorial is to provide “end-to-end” instructions on implementing a state-space controller for a flywheel.  By following this tutorial, readers will learn how to:</p>
<ol class="arabic simple">
<li><p>Create an accurate state-space model of a flywheel using <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-system-identification"><span class="xref std std-term">system identification</span></a> or CAD software.</p></li>
<li><p>Implement a Kalman Filter to filter encoder velocity measurements without lag.</p></li>
<li><p>Implement a <a class="reference internal" href="state-space-intro.html#the-linear-quadratic-regulator"><span class="std std-ref">LQR</span></a> feedback controller which, when combined with model-based feedforward, will generate voltage <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-input"><span class="xref std std-term">inputs</span></a> to drive the flywheel to a <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-reference"><span class="xref std std-term">reference</span></a>.</p></li>
</ol>
<p>This tutorial is intended to be approachable for teams without a great deal of programming expertise.  While the WPILib library offers significant flexibility in the manner in which its state-space control features are implemented, closely following the implementation outlined in this tutorial should provide teams with a basic structure which can be reused for a variety of state-space systems.</p>
<p>The full example is available in the state-space flywheel (<a class="reference external" href="https://github.com/wpilibsuite/allwpilib/blob/main/wpilibjExamples/src/main/java/edu/wpi/first/wpilibj/examples/statespaceflywheel/Robot.java">Java</a>/<a class="reference external" href="https://github.com/wpilibsuite/allwpilib/blob/main/wpilibcExamples/src/main/cpp/examples/StateSpaceFlywheel/cpp/Robot.cpp">C++</a>) and state-space flywheel system identification (<a class="reference external" href="https://github.com/wpilibsuite/allwpilib/blob/main/wpilibjExamples/src/main/java/edu/wpi/first/wpilibj/examples/statespaceflywheelsysid/Robot.java">Java</a>/<a class="reference external" href="https://github.com/wpilibsuite/allwpilib/blob/main/wpilibcExamples/src/main/cpp/examples/StateSpaceFlywheelSysId/cpp/Robot.cpp">C++</a>) example projects.</p>
<section id="why-use-state-space-control">
<h2>Why Use State-Space Control?<a class="headerlink" href="#why-use-state-space-control" title="Permalink to this heading"></a></h2>
<p>Because state-space control focuses on creating an accurate model of our system, we can accurately predict how our <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-model"><span class="xref std std-term">model</span></a> will respond to control <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-input"><span class="xref std std-term">inputs</span></a>. This allows us to simulate our mechanisms without access to a physical robot, as well as easily choose <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-gain"><span class="xref std std-term">gains</span></a> that we know will work well. Having a model also allows us to create lagless filters, such as Kalman Filters, to optimally filter sensor readings.</p>
</section>
<section id="modeling-our-flywheel">
<h2>Modeling Our Flywheel<a class="headerlink" href="#modeling-our-flywheel" title="Permalink to this heading"></a></h2>
<p><a class="reference internal" href="state-space-intro.html#what-is-state-space-notation"><span class="std std-ref">Recall</span></a> that continuous state-space systems are modeled using the following system of equations:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\dot{\mathbf{x}} &amp;= \mathbf{A}\mathbf{x} + \mathbf{B}\mathbf{u} \\
\mathbf{y} &amp;= \mathbf{C}\mathbf{x} + \mathbf{D}\mathbf{u}\end{split}\]</div>
<p>Where <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-x-dot"><span class="xref std std-term">x-dot</span></a> is the rate of change of the <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-system"><span class="xref std std-term">system</span></a>’s <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-state"><span class="xref std std-term">state</span></a>, <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> is the system’s current state, <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> is the <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-input"><span class="xref std std-term">input</span></a> to the system, and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> is the system’s <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-output"><span class="xref std std-term">output</span></a>.</p>
<p>Let’s use this system of equations to model our flywheel in two different ways. We’ll first model it using <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-system-identification"><span class="xref std std-term">system identification</span></a> using the SysId toolsuite, and then model it based on the motor and flywheel’s <a class="hxr-hoverxref hxr-tooltip reference internal" href="../../frc-glossary.html#term-moment-of-inertia"><span class="xref std std-term">moment of inertia</span></a>.</p>
<p>The first step of building up our state-space system is picking our system’s states. We can pick anything we want as a state – we could pick completely unrelated states if we wanted – but it helps to pick states that are important. We can include <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-hidden-state"><span class="xref std std-term">hidden states</span></a> in our state (such as elevator velocity if we were only able to measure its position) and let our Kalman Filter estimate their values. Remember that the states we choose will be driven towards their respective <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-reference"><span class="xref std std-term">references</span></a> by the feedback controller (typically the <a class="reference internal" href="state-space-intro.html#the-linear-quadratic-regulator"><span class="std std-ref">Linear-Quadratic Regulator</span></a> since it’s optimal).</p>
<p>For our flywheel, we care only about one state: its velocity. While we could chose to also model its acceleration, the inclusion of this state isn’t necessary for our system.</p>
<p>Next, we identify the <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-input"><span class="xref std std-term">inputs</span></a> to our system. Inputs can be thought of as things we can put “into” our system to change its state. In the case of the flywheel (and many other single-jointed mechanisms in FRC®), we have just one input: voltage applied to the motor. By choosing voltage as our input (over something like motor duty cycle), we can compensate for battery voltage sag as battery load increases.</p>
<p>A continuous-time state-space system writes <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-x-dot"><span class="xref std std-term">x-dot</span></a>, or the instantaneous rate of change of the system’s <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-system"><span class="xref std std-term">system</span></a>'s state, as proportional to the current <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-state"><span class="xref std std-term">state</span></a> and <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-input"><span class="xref std std-term">inputs</span></a>. Because our state is angular velocity, <span class="math notranslate nohighlight">\(\mathbf{\dot{x}}\)</span> will be the flywheel’s angular acceleration.</p>
<p>Next, we will model our flywheel as a continuous-time state-space system. WPILib’s <code class="docutils literal notranslate"><span class="pre">LinearSystem</span></code> will convert this to discrete-time internally. Review <a class="reference internal" href="state-space-intro.html#what-is-state-space-notation"><span class="std std-ref">state-space notation</span></a> for more on continuous-time and discrete-time systems.</p>
<section id="modeling-with-system-identification">
<h3>Modeling with System Identification<a class="headerlink" href="#modeling-with-system-identification" title="Permalink to this heading"></a></h3>
<p>To rewrite this in state-space notation using <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-system-identification"><span class="xref std std-term">system identification</span></a>, we recall from the flywheel <a class="reference internal" href="state-space-intro.html#state-space-notation-example-flywheel-from-kv-and-ka"><span class="std std-ref">state-space notation example</span></a>, where we rewrote the following equation in terms of <span class="math notranslate nohighlight">\(\mathbf{a}\)</span>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}V = kV \cdot \mathbf{v} + kA \cdot \mathbf{a}\\
\mathbf{a} = \mathbf{\dot{v}} = \begin{bmatrix}\frac{-kV}{kA}\end{bmatrix} v + \begin{bmatrix}\frac{1}{kA}\end{bmatrix} V\end{split}\]</div>
<p>Where <span class="math notranslate nohighlight">\(\mathbf{v}\)</span> is flywheel velocity, <span class="math notranslate nohighlight">\(\mathbf{a}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{\dot{v}}\)</span> are flywheel acceleration, and <span class="math notranslate nohighlight">\(V\)</span> is voltage. Rewriting this with the standard convention of <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> for the state vector and <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> for the input vector, we find:</p>
<div class="math notranslate nohighlight">
\[\mathbf{\dot{x}} = \begin{bmatrix}\frac{-kV}{kA} \end{bmatrix} \mathbf{x} + \begin{bmatrix}\frac{1}{kA} \end{bmatrix} \mathbf{u}\]</div>
<p>The second part of state-space notation relates the system’s current <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-state"><span class="xref std std-term">state</span></a> and <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-input"><span class="xref std std-term">inputs</span></a> to the <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-output"><span class="xref std std-term">output</span></a>. In the case of a flywheel, our output vector <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> (or things that our sensors can measure) is our flywheel’s velocity, which also happens to be an element of our <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-state"><span class="xref std std-term">state</span></a> vector <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>. Therefore, our output matrix is <span class="math notranslate nohighlight">\(\mathbf{C} = \begin{bmatrix}1 \end{bmatrix}\)</span>, and our system feedthrough matrix is <span class="math notranslate nohighlight">\(\mathbf{D} = \begin{bmatrix}0 \end{bmatrix}\)</span>. Writing this out in continuous-time state-space notation yields the following.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbf{\dot{x}} &amp;= \begin{bmatrix}\frac{-kV}{kA} \end{bmatrix} \mathbf{x} + \begin{bmatrix}\frac{1}{kA} \end{bmatrix} \mathbf{u} \\
\mathbf{y} &amp;= \begin{bmatrix}1\end{bmatrix} \mathbf{x} + \begin{bmatrix}0\end{bmatrix} \mathbf{u}\end{split}\]</div>
<p>The <code class="docutils literal notranslate"><span class="pre">LinearSystem</span></code> class contains methods for easily creating state-space systems identified using <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-system-identification"><span class="xref std std-term">system identification</span></a>. This example shows a flywheel model with a kV of 0.023 and a kA of 0.001:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-SmF2YQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-SmF2YQ==" name="SmF2YQ==" role="tab" tabindex="0">Java</button><button aria-controls="panel-0-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-0-SmF2YQ==" class="sphinx-tabs-panel group-tab" id="panel-0-SmF2YQ==" name="SmF2YQ==" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="linenos">33</span><span class="w">  </span><span class="c1">// Volts per (radian per second)</span><span class="w"></span>
<span class="linenos">34</span><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">kFlywheelKv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.023</span><span class="p">;</span><span class="w"></span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">  </span><span class="c1">// Volts per (radian per second squared)</span><span class="w"></span>
<span class="linenos">37</span><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">kFlywheelKa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.001</span><span class="p">;</span><span class="w"></span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">  </span><span class="c1">// The plant holds a state-space model of our flywheel. This system has the following properties:</span><span class="w"></span>
<span class="linenos">40</span><span class="w">  </span><span class="c1">//</span><span class="w"></span>
<span class="linenos">41</span><span class="w">  </span><span class="c1">// States: [velocity], in radians per second.</span><span class="w"></span>
<span class="linenos">42</span><span class="w">  </span><span class="c1">// Inputs (what we can &quot;put in&quot;): [voltage], in volts.</span><span class="w"></span>
<span class="linenos">43</span><span class="w">  </span><span class="c1">// Outputs (what we can measure): [velocity], in radians per second.</span><span class="w"></span>
<span class="linenos">44</span><span class="w">  </span><span class="c1">//</span><span class="w"></span>
<span class="linenos">45</span><span class="w">  </span><span class="c1">// The Kv and Ka constants are found using the FRC Characterization toolsuite.</span><span class="w"></span>
<span class="linenos">46</span><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LinearSystem</span><span class="o">&lt;</span><span class="n">N1</span><span class="p">,</span><span class="w"> </span><span class="n">N1</span><span class="p">,</span><span class="w"> </span><span class="n">N1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_flywheelPlant</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">47</span><span class="w">      </span><span class="n">LinearSystemId</span><span class="p">.</span><span class="na">identifyVelocitySystem</span><span class="p">(</span><span class="n">kFlywheelKv</span><span class="p">,</span><span class="w"> </span><span class="n">kFlywheelKa</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">17</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/system/plant/LinearSystemId.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">32</span><span class="w">  </span><span class="c1">// Volts per (radian per second)</span>
<span class="linenos">33</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">kFlywheelKv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.023</span><span class="n">_V</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1</span><span class="n">_rad_per_s</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">  </span><span class="c1">// Volts per (radian per second squared)</span>
<span class="linenos">36</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">kFlywheelKa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.001</span><span class="n">_V</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1</span><span class="n">_rad_per_s_sq</span><span class="p">;</span><span class="w"></span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="w">  </span><span class="c1">// The plant holds a state-space model of our flywheel. This system has the</span>
<span class="linenos">39</span><span class="w">  </span><span class="c1">// following properties:</span>
<span class="linenos">40</span><span class="w">  </span><span class="c1">//</span>
<span class="linenos">41</span><span class="w">  </span><span class="c1">// States: [velocity], in radians per second.</span>
<span class="linenos">42</span><span class="w">  </span><span class="c1">// Inputs (what we can &quot;put in&quot;): [voltage], in volts.</span>
<span class="linenos">43</span><span class="w">  </span><span class="c1">// Outputs (what we can measure): [velocity], in radians per second.</span>
<span class="linenos">44</span><span class="w">  </span><span class="c1">//</span>
<span class="linenos">45</span><span class="w">  </span><span class="c1">// The Kv and Ka constants are found using the FRC Characterization toolsuite.</span>
<span class="linenos">46</span><span class="w">  </span><span class="n">frc</span><span class="o">::</span><span class="n">LinearSystem</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_flywheelPlant</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">47</span><span class="w">      </span><span class="n">frc</span><span class="o">::</span><span class="n">LinearSystemId</span><span class="o">::</span><span class="n">IdentifyVelocitySystem</span><span class="o">&lt;</span><span class="n">units</span><span class="o">::</span><span class="n">radian</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kFlywheelKv</span><span class="p">,</span><span class="w"></span>
<span class="linenos">48</span><span class="w">                                                                 </span><span class="n">kFlywheelKa</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div></div>
</section>
<section id="modeling-using-flywheel-moment-of-inertia-and-gearing">
<h3>Modeling Using Flywheel Moment of Inertia and Gearing<a class="headerlink" href="#modeling-using-flywheel-moment-of-inertia-and-gearing" title="Permalink to this heading"></a></h3>
<p>A flywheel can also be modeled without access to a physical robot, using information about the motors, gearing and flywheel’s <a class="hxr-hoverxref hxr-tooltip reference internal" href="../../frc-glossary.html#term-moment-of-inertia"><span class="xref std std-term">moment of inertia</span></a>. A full derivation of this model is presented in Section 8.2.1 of  <a class="reference external" href="https://file.tavsys.net/control/controls-engineering-in-frc.pdf">Controls Engineering in FRC</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">LinearSystem</span></code> class contains methods to easily create a model of a flywheel from the flywheel’s motors, gearing and <a class="hxr-hoverxref hxr-tooltip reference internal" href="../../frc-glossary.html#term-moment-of-inertia"><span class="xref std std-term">moment of inertia</span></a>. The moment of inertia can be calculated using CAD software or using physics. The examples used here are detailed in the flywheel example project (<a class="reference external" href="https://github.com/wpilibsuite/allwpilib/tree/v2023.2.1/wpilibjExamples/src/main/java/edu/wpi/first/wpilibj/examples/statespaceflywheel">Java</a>/<a class="reference external" href="https://github.com/wpilibsuite/allwpilib/blob/v2023.2.1/wpilibcExamples/src/main/cpp/examples/StateSpaceFlywheel/cpp/Robot.cpp">C++</a>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For WPILib’s state-space classes, gearing is written as output over input – that is, if the flywheel spins slower than the motors, this number should be greater than one.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The C++ LinearSystem class uses <a class="reference internal" href="../../basic-programming/cpp-units.html#the-c-units-library"><span class="std std-ref">the C++ Units Library</span></a> to prevent unit mixups and assert dimensionality.</p>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-SmF2YQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-SmF2YQ==" name="SmF2YQ==" role="tab" tabindex="0">Java</button><button aria-controls="panel-1-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-1-SmF2YQ==" class="sphinx-tabs-panel group-tab" id="panel-1-SmF2YQ==" name="SmF2YQ==" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="linenos">34</span><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">kFlywheelMomentOfInertia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00032</span><span class="p">;</span><span class="w"> </span><span class="c1">// kg * m^2</span><span class="w"></span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">  </span><span class="c1">// Reduction between motors and encoder, as output over input. If the flywheel spins slower than</span><span class="w"></span>
<span class="linenos">37</span><span class="w">  </span><span class="c1">// the motors, this number should be greater than one.</span><span class="w"></span>
<span class="linenos">38</span><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">kFlywheelGearing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">  </span><span class="c1">// The plant holds a state-space model of our flywheel. This system has the following properties:</span><span class="w"></span>
<span class="linenos">41</span><span class="w">  </span><span class="c1">//</span><span class="w"></span>
<span class="linenos">42</span><span class="w">  </span><span class="c1">// States: [velocity], in radians per second.</span><span class="w"></span>
<span class="linenos">43</span><span class="w">  </span><span class="c1">// Inputs (what we can &quot;put in&quot;): [voltage], in volts.</span><span class="w"></span>
<span class="linenos">44</span><span class="w">  </span><span class="c1">// Outputs (what we can measure): [velocity], in radians per second.</span><span class="w"></span>
<span class="linenos">45</span><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LinearSystem</span><span class="o">&lt;</span><span class="n">N1</span><span class="p">,</span><span class="w"> </span><span class="n">N1</span><span class="p">,</span><span class="w"> </span><span class="n">N1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_flywheelPlant</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">46</span><span class="w">      </span><span class="n">LinearSystemId</span><span class="p">.</span><span class="na">createFlywheelSystem</span><span class="p">(</span><span class="w"></span>
<span class="linenos">47</span><span class="w">          </span><span class="n">DCMotor</span><span class="p">.</span><span class="na">getNEO</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">kFlywheelMomentOfInertia</span><span class="p">,</span><span class="w"> </span><span class="n">kFlywheelGearing</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">17</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/system/plant/LinearSystemId.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">31</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="n">units</span><span class="o">::</span><span class="n">kilogram_square_meter_t</span><span class="w"> </span><span class="n">kFlywheelMomentOfInertia</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">32</span><span class="w">      </span><span class="mf">0.00032</span><span class="n">_kg_sq_m</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="w">  </span><span class="c1">// Reduction between motors and encoder, as output over input. If the flywheel</span>
<span class="linenos">35</span><span class="w">  </span><span class="c1">// spins slower than the motors, this number should be greater than one.</span>
<span class="linenos">36</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">kFlywheelGearing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="w">  </span><span class="c1">// The plant holds a state-space model of our flywheel. This system has the</span>
<span class="linenos">39</span><span class="w">  </span><span class="c1">// following properties:</span>
<span class="linenos">40</span><span class="w">  </span><span class="c1">//</span>
<span class="linenos">41</span><span class="w">  </span><span class="c1">// States: [velocity], in radians per second.</span>
<span class="linenos">42</span><span class="w">  </span><span class="c1">// Inputs (what we can &quot;put in&quot;): [voltage], in volts.</span>
<span class="linenos">43</span><span class="w">  </span><span class="c1">// Outputs (what we can measure): [velocity], in radians per second.</span>
<span class="linenos">44</span><span class="w">  </span><span class="n">frc</span><span class="o">::</span><span class="n">LinearSystem</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_flywheelPlant</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">45</span><span class="w">      </span><span class="n">frc</span><span class="o">::</span><span class="n">LinearSystemId</span><span class="o">::</span><span class="n">FlywheelSystem</span><span class="p">(</span><span class="w"></span>
<span class="linenos">46</span><span class="w">          </span><span class="n">frc</span><span class="o">::</span><span class="n">DCMotor</span><span class="o">::</span><span class="n">NEO</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">kFlywheelMomentOfInertia</span><span class="p">,</span><span class="w"> </span><span class="n">kFlywheelGearing</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="kalman-filters-observing-flywheel-state">
<h2>Kalman Filters: Observing Flywheel State<a class="headerlink" href="#kalman-filters-observing-flywheel-state" title="Permalink to this heading"></a></h2>
<p>Kalman filters are used to filter our velocity measurements using our state-space model to generate a state estimate <span class="math notranslate nohighlight">\(\mathbf{\hat{x}}\)</span>. As our flywheel model is linear, we can use a Kalman filter to estimate the flywheel’s velocity. WPILib’s Kalman filter takes a <code class="docutils literal notranslate"><span class="pre">LinearSystem</span></code> (which we found above), along with standard deviations of model and sensor measurements. We can adjust how “smooth” our state estimate is by adjusting these weights. Larger state standard deviations will cause the filter to “distrust” our state estimate and favor new measurements more highly, while larger measurement standard deviations will do the opposite.</p>
<p>In the case of a flywheel we start with a state standard deviation of 3 rad/s and a measurement standard deviation of 0.01 rad/s. These values are up to the user to choose – these weights produced a filter that was tolerant to some noise but whose state estimate quickly reacted to external disturbances for <em>a</em> flywheel – and should be tuned to create a filter that behaves well for your specific flywheel. Graphing states, measurements, inputs, references, and outputs over time is a great visual way to tune Kalman filters.</p>
<img alt="The effect of a Kalman, median, and IIR filters on some flywheel data." src="../../../../_images/filter_comparison.png" />
<p>The above graph shows two differently tuned Kalman filters, as well as a <a class="reference internal" href="../filters/linear-filter.html#linear-filters"><span class="std std-ref">single-pole IIR filter</span></a> and a <a class="reference internal" href="../filters/median-filter.html#median-filter"><span class="std std-ref">Median Filter</span></a>. This data was collected with a shooter over ~5 seconds, and four balls were run through the shooter (as seen in the four dips in velocity). While there are no hard rules on choosing good state and measurement standard deviations, they should in general be tuned to trust the model enough to reject noise while reacting quickly to external disturbances.</p>
<p>Because the feedback controller computes error using the <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-x-hat"><span class="xref std std-term">x-hat</span></a> estimated by the Kalman filter, the controller will react to disturbances only as quickly the filter’s state estimate changes. In the above chart, the upper left plot (with a state standard deviation of 3.0 and measurement standard deviation of 0.2) produced a filter that reacted quickly to disturbances while rejecting noise, while the upper right plot shows a filter that was barely affected by the velocity dips.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-SmF2YQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-SmF2YQ==" name="SmF2YQ==" role="tab" tabindex="0">Java</button><button aria-controls="panel-2-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-2-SmF2YQ==" class="sphinx-tabs-panel group-tab" id="panel-2-SmF2YQ==" name="SmF2YQ==" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="linenos">59</span><span class="w">  </span><span class="c1">// The observer fuses our encoder data and voltage inputs to reject noise.</span><span class="w"></span>
<span class="linenos">60</span><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">KalmanFilter</span><span class="o">&lt;</span><span class="n">N1</span><span class="p">,</span><span class="w"> </span><span class="n">N1</span><span class="p">,</span><span class="w"> </span><span class="n">N1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_observer</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">61</span><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">KalmanFilter</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="linenos">62</span><span class="w">          </span><span class="n">Nat</span><span class="p">.</span><span class="na">N1</span><span class="p">(),</span><span class="w"></span>
<span class="linenos">63</span><span class="w">          </span><span class="n">Nat</span><span class="p">.</span><span class="na">N1</span><span class="p">(),</span><span class="w"></span>
<span class="linenos">64</span><span class="w">          </span><span class="n">m_flywheelPlant</span><span class="p">,</span><span class="w"></span>
<span class="linenos">65</span><span class="w">          </span><span class="n">VecBuilder</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="mf">3.0</span><span class="p">),</span><span class="w"> </span><span class="c1">// How accurate we think our model is</span><span class="w"></span>
<span class="linenos">66</span><span class="w">          </span><span class="n">VecBuilder</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span><span class="w"> </span><span class="c1">// How accurate we think our encoder</span><span class="w"></span>
<span class="linenos">67</span><span class="w">          </span><span class="c1">// data is</span><span class="w"></span>
<span class="linenos">68</span><span class="w">          </span><span class="mf">0.020</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">13</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/estimator/KalmanFilter.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">48</span><span class="w">  </span><span class="c1">// The observer fuses our encoder data and voltage inputs to reject noise.</span>
<span class="linenos">49</span><span class="w">  </span><span class="n">frc</span><span class="o">::</span><span class="n">KalmanFilter</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_observer</span><span class="p">{</span><span class="w"></span>
<span class="linenos">50</span><span class="w">      </span><span class="n">m_flywheelPlant</span><span class="p">,</span><span class="w"></span>
<span class="linenos">51</span><span class="w">      </span><span class="p">{</span><span class="mf">3.0</span><span class="p">},</span><span class="w">   </span><span class="c1">// How accurate we think our model is</span>
<span class="linenos">52</span><span class="w">      </span><span class="p">{</span><span class="mf">0.01</span><span class="p">},</span><span class="w">  </span><span class="c1">// How accurate we think our encoder data is</span>
<span class="linenos">53</span><span class="w">      </span><span class="mi">20</span><span class="n">_ms</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div></div>
<p>Because Kalman filters use our state-space model in the <a class="reference internal" href="state-space-observers.html#predict-step"><span class="std std-ref">Predict step</span></a>, it is important that our model is as accurate as possible. One way to verify this is to record a flywheel’s input voltage and velocity over time, and replay this data by calling only <code class="docutils literal notranslate"><span class="pre">predict</span></code> on the Kalman filter. Then, the kV and kA gains (or moment of inertia and other constants) can be adjusted until the model closely matches the recorded data.</p>
</section>
<section id="linear-quadratic-regulators-and-plant-inversion-feedforward">
<h2>Linear-Quadratic Regulators and Plant Inversion Feedforward<a class="headerlink" href="#linear-quadratic-regulators-and-plant-inversion-feedforward" title="Permalink to this heading"></a></h2>
<p><a class="reference internal" href="state-space-intro.html#the-linear-quadratic-regulator"><span class="std std-ref">The Linear-Quadratic Regulator</span></a> finds a feedback controller to drive our flywheel <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-system"><span class="xref std std-term">system</span></a> to its <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-reference"><span class="xref std std-term">reference</span></a>. Because our flywheel has just one state, the control law picked by our LQR will be in the form <span class="math notranslate nohighlight">\(\mathbf{u = K (r - x)}\)</span> where <span class="math notranslate nohighlight">\(\mathbf{K}\)</span> is a 1x1 matrix; in other words, the control law picked by LQR is simply a proportional controller, or a PID controller with only a P gain. This gain is chosen by our LQR based on the state excursion and control efforts we pass it. More on tuning LQR controllers can be found in the <a class="reference internal" href="state-space-intro.html#lqr-example-application"><span class="std std-ref">LQR application example</span></a>.</p>
<p>Much like <code class="docutils literal notranslate"><span class="pre">SimpleMotorFeedforward</span></code> can be used to generate feedforward voltage inputs given kS, kV, and kA constants, the Plant Inversion Feedforward class generate <a class="reference internal" href="state-space-intro.html#visualizing-feedforward"><span class="std std-ref">feedforward</span></a> voltage inputs given a state-space system. The voltage commands generated by the <code class="docutils literal notranslate"><span class="pre">LinearSystemLoop</span></code> class are the sum of the feedforward and feedback inputs.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-SmF2YQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-SmF2YQ==" name="SmF2YQ==" role="tab" tabindex="0">Java</button><button aria-controls="panel-3-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-3-SmF2YQ==" class="sphinx-tabs-panel group-tab" id="panel-3-SmF2YQ==" name="SmF2YQ==" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="linenos">60</span><span class="w">  </span><span class="c1">// A LQR uses feedback to create voltage commands.</span><span class="w"></span>
<span class="linenos">61</span><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LinearQuadraticRegulator</span><span class="o">&lt;</span><span class="n">N1</span><span class="p">,</span><span class="w"> </span><span class="n">N1</span><span class="p">,</span><span class="w"> </span><span class="n">N1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_controller</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">62</span><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">LinearQuadraticRegulator</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="w"></span>
<span class="linenos">63</span><span class="w">          </span><span class="n">m_flywheelPlant</span><span class="p">,</span><span class="w"></span>
<span class="linenos">64</span><span class="w">          </span><span class="n">VecBuilder</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="mf">8.0</span><span class="p">),</span><span class="w"> </span><span class="c1">// qelms. Velocity error tolerance, in radians per second. Decrease</span><span class="w"></span>
<span class="linenos">65</span><span class="w">          </span><span class="c1">// this to more heavily penalize state excursion, or make the controller behave more</span><span class="w"></span>
<span class="linenos">66</span><span class="w">          </span><span class="c1">// aggressively.</span><span class="w"></span>
<span class="linenos">67</span><span class="w">          </span><span class="n">VecBuilder</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="mf">12.0</span><span class="p">),</span><span class="w"> </span><span class="c1">// relms. Control effort (voltage) tolerance. Decrease this to more</span><span class="w"></span>
<span class="linenos">68</span><span class="w">          </span><span class="c1">// heavily penalize control effort, or make the controller less aggressive. 12 is a good</span><span class="w"></span>
<span class="linenos">69</span><span class="w">          </span><span class="c1">// starting point because that is the (approximate) maximum voltage of a battery.</span><span class="w"></span>
<span class="linenos">70</span><span class="w">          </span><span class="mf">0.020</span><span class="p">);</span><span class="w"> </span><span class="c1">// Nominal time between loops. 0.020 for TimedRobot, but can be</span><span class="w"></span>
<span class="linenos">71</span><span class="w">  </span><span class="c1">// lower if using notifiers.</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">11</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/controller/LinearQuadraticRegulator.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">54</span><span class="w">  </span><span class="c1">// A LQR uses feedback to create voltage commands.</span>
<span class="linenos">55</span><span class="w">  </span><span class="n">frc</span><span class="o">::</span><span class="n">LinearQuadraticRegulator</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_controller</span><span class="p">{</span><span class="w"></span>
<span class="linenos">56</span><span class="w">      </span><span class="n">m_flywheelPlant</span><span class="p">,</span><span class="w"></span>
<span class="linenos">57</span><span class="w">      </span><span class="c1">// qelms. Velocity error tolerance, in radians per second. Decrease this</span>
<span class="linenos">58</span><span class="w">      </span><span class="c1">// to more heavily penalize state excursion, or make the controller behave</span>
<span class="linenos">59</span><span class="w">      </span><span class="c1">// more aggressively.</span>
<span class="linenos">60</span><span class="w">      </span><span class="p">{</span><span class="mf">8.0</span><span class="p">},</span><span class="w"></span>
<span class="linenos">61</span><span class="w">      </span><span class="c1">// relms. Control effort (voltage) tolerance. Decrease this to more</span>
<span class="linenos">62</span><span class="w">      </span><span class="c1">// heavily penalize control effort, or make the controller less</span>
<span class="linenos">63</span><span class="w">      </span><span class="c1">// aggressive. 12 is a good starting point because that is the</span>
<span class="linenos">64</span><span class="w">      </span><span class="c1">// (approximate) maximum voltage of a battery.</span>
<span class="linenos">65</span><span class="w">      </span><span class="p">{</span><span class="mf">12.0</span><span class="p">},</span><span class="w"></span>
<span class="linenos">66</span><span class="w">      </span><span class="c1">// Nominal time between loops. 20ms for TimedRobot, but can be lower if</span>
<span class="linenos">67</span><span class="w">      </span><span class="c1">// using notifiers.</span>
<span class="linenos">68</span><span class="w">      </span><span class="mi">20</span><span class="n">_ms</span><span class="p">};</span><span class="w"></span>
<span class="linenos">69</span>
<span class="linenos">70</span><span class="w">  </span><span class="c1">// The state-space loop combines a controller, observer, feedforward and plant</span>
<span class="linenos">71</span><span class="w">  </span><span class="c1">// for easy control.</span>
<span class="linenos">72</span><span class="w">  </span><span class="n">frc</span><span class="o">::</span><span class="n">LinearSystemLoop</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_loop</span><span class="p">{</span><span class="n">m_flywheelPlant</span><span class="p">,</span><span class="w"> </span><span class="n">m_controller</span><span class="p">,</span><span class="w"></span>
<span class="linenos">73</span><span class="w">                                        </span><span class="n">m_observer</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="n">_V</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="n">_ms</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div></div>
</section>
<section id="bringing-it-all-together-linearsystemloop">
<h2>Bringing it All Together: LinearSystemLoop<a class="headerlink" href="#bringing-it-all-together-linearsystemloop" title="Permalink to this heading"></a></h2>
<p>LinearSystemLoop combines our system, controller, and observer that we created earlier. The constructor shown will also instantiate a <code class="docutils literal notranslate"><span class="pre">PlantInversionFeedforward</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-SmF2YQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-4-SmF2YQ==" name="SmF2YQ==" role="tab" tabindex="0">Java</button><button aria-controls="panel-4-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-4-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-4-SmF2YQ==" class="sphinx-tabs-panel group-tab" id="panel-4-SmF2YQ==" name="SmF2YQ==" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="linenos">73</span><span class="w">  </span><span class="c1">// The state-space loop combines a controller, observer, feedforward and plant for easy control.</span><span class="w"></span>
<span class="linenos">74</span><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LinearSystemLoop</span><span class="o">&lt;</span><span class="n">N1</span><span class="p">,</span><span class="w"> </span><span class="n">N1</span><span class="p">,</span><span class="w"> </span><span class="n">N1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_loop</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos">75</span><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">LinearSystemLoop</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">m_flywheelPlant</span><span class="p">,</span><span class="w"> </span><span class="n">m_controller</span><span class="p">,</span><span class="w"> </span><span class="n">m_observer</span><span class="p">,</span><span class="w"> </span><span class="mf">12.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.020</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-4-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">15</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/system/LinearSystemLoop.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">71</span><span class="w">  </span><span class="c1">// The state-space loop combines a controller, observer, feedforward and plant</span>
<span class="linenos">72</span><span class="w">  </span><span class="c1">// for easy control.</span>
<span class="linenos">73</span><span class="w">  </span><span class="n">frc</span><span class="o">::</span><span class="n">LinearSystemLoop</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_loop</span><span class="p">{</span><span class="n">m_flywheelPlant</span><span class="p">,</span><span class="w"> </span><span class="n">m_controller</span><span class="p">,</span><span class="w"></span>
<span class="linenos">74</span><span class="w">                                        </span><span class="n">m_observer</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="n">_V</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="n">_ms</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div></div>
<p>Once we have our <code class="docutils literal notranslate"><span class="pre">LinearSystemLoop</span></code>, the only thing left to do is actually run it. To do that, we’ll periodically update our Kalman filter with our new encoder velocity measurements and apply new voltage commands to it. To do that, we first set the <a class="hxr-hoverxref hxr-tooltip reference internal" href="../controls-glossary.html#term-reference"><span class="xref std std-term">reference</span></a>, then <code class="docutils literal notranslate"><span class="pre">correct</span></code> with the current flywheel speed, <code class="docutils literal notranslate"><span class="pre">predict</span></code> the Kalman filter into the next timestep, and apply the inputs generated using <code class="docutils literal notranslate"><span class="pre">getU</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-SmF2YQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-5-SmF2YQ==" name="SmF2YQ==" role="tab" tabindex="0">Java</button><button aria-controls="panel-5-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-5-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-5-SmF2YQ==" class="sphinx-tabs-panel group-tab" id="panel-5-SmF2YQ==" name="SmF2YQ==" role="tabpanel" tabindex="0"><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 96</span><span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="linenos"> 97</span><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">teleopPeriodic</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">    </span><span class="c1">// Sets the target speed of our flywheel. This is similar to setting the setpoint of a</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">    </span><span class="c1">// PID controller.</span><span class="w"></span>
<span class="linenos">100</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_joystick</span><span class="p">.</span><span class="na">getTriggerPressed</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">101</span><span class="w">      </span><span class="c1">// We just pressed the trigger, so let&#39;s set our next reference</span><span class="w"></span>
<span class="linenos">102</span><span class="w">      </span><span class="n">m_loop</span><span class="p">.</span><span class="na">setNextR</span><span class="p">(</span><span class="n">VecBuilder</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="n">kSpinupRadPerSec</span><span class="p">));</span><span class="w"></span>
<span class="linenos">103</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_joystick</span><span class="p">.</span><span class="na">getTriggerReleased</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">104</span><span class="w">      </span><span class="c1">// We just released the trigger, so let&#39;s spin down</span><span class="w"></span>
<span class="linenos">105</span><span class="w">      </span><span class="n">m_loop</span><span class="p">.</span><span class="na">setNextR</span><span class="p">(</span><span class="n">VecBuilder</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="mf">0.0</span><span class="p">));</span><span class="w"></span>
<span class="linenos">106</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">107</span>
<span class="linenos">108</span><span class="w">    </span><span class="c1">// Correct our Kalman filter&#39;s state vector estimate with encoder data.</span><span class="w"></span>
<span class="linenos">109</span><span class="w">    </span><span class="n">m_loop</span><span class="p">.</span><span class="na">correct</span><span class="p">(</span><span class="n">VecBuilder</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="n">m_encoder</span><span class="p">.</span><span class="na">getRate</span><span class="p">()));</span><span class="w"></span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="w">    </span><span class="c1">// Update our LQR to generate new voltage commands and use the voltages to predict the next</span><span class="w"></span>
<span class="linenos">112</span><span class="w">    </span><span class="c1">// state with out Kalman filter.</span><span class="w"></span>
<span class="linenos">113</span><span class="w">    </span><span class="n">m_loop</span><span class="p">.</span><span class="na">predict</span><span class="p">(</span><span class="mf">0.020</span><span class="p">);</span><span class="w"></span>
<span class="linenos">114</span>
<span class="linenos">115</span><span class="w">    </span><span class="c1">// Send the new calculated voltage to the motors.</span><span class="w"></span>
<span class="linenos">116</span><span class="w">    </span><span class="c1">// voltage = duty cycle * battery voltage, so</span><span class="w"></span>
<span class="linenos">117</span><span class="w">    </span><span class="c1">// duty cycle = voltage / battery voltage</span><span class="w"></span>
<span class="linenos">118</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">nextVoltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_loop</span><span class="p">.</span><span class="na">getU</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">119</span><span class="w">    </span><span class="n">m_motor</span><span class="p">.</span><span class="na">setVoltage</span><span class="p">(</span><span class="n">nextVoltage</span><span class="p">);</span><span class="w"></span>
<span class="linenos">120</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">121</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-5-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;numbers&gt;</span><span class="cp"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/DriverStation.h&gt;</span><span class="cp"></span>
<span class="linenos"> 8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/Encoder.h&gt;</span><span class="cp"></span>
<span class="linenos"> 9</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/TimedRobot.h&gt;</span><span class="cp"></span>
<span class="linenos">10</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/XboxController.h&gt;</span><span class="cp"></span>
<span class="linenos">11</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/controller/LinearQuadraticRegulator.h&gt;</span><span class="cp"></span>
<span class="linenos">12</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/drive/DifferentialDrive.h&gt;</span><span class="cp"></span>
<span class="linenos">13</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/estimator/KalmanFilter.h&gt;</span><span class="cp"></span>
<span class="linenos">14</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/motorcontrol/PWMSparkMax.h&gt;</span><span class="cp"></span>
<span class="linenos">15</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/system/LinearSystemLoop.h&gt;</span><span class="cp"></span>
<span class="linenos">16</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/system/plant/DCMotor.h&gt;</span><span class="cp"></span>
<span class="linenos">17</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;frc/system/plant/LinearSystemId.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 92</span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">TeleopPeriodic</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 93</span><span class="w">    </span><span class="c1">// Sets the target speed of our flywheel. This is similar to setting the</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="c1">// setpoint of a PID controller.</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_joystick</span><span class="p">.</span><span class="n">GetRightBumper</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 96</span><span class="w">      </span><span class="c1">// We pressed the bumper, so let&#39;s set our next reference</span>
<span class="linenos"> 97</span><span class="w">      </span><span class="n">m_loop</span><span class="p">.</span><span class="n">SetNextR</span><span class="p">(</span><span class="n">frc</span><span class="o">::</span><span class="n">Vectord</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span><span class="n">kSpinup</span><span class="p">.</span><span class="n">value</span><span class="p">()});</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">      </span><span class="c1">// We released the bumper, so let&#39;s spin down</span>
<span class="linenos">100</span><span class="w">      </span><span class="n">m_loop</span><span class="p">.</span><span class="n">SetNextR</span><span class="p">(</span><span class="n">frc</span><span class="o">::</span><span class="n">Vectord</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span><span class="mf">0.0</span><span class="p">});</span><span class="w"></span>
<span class="linenos">101</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="w">    </span><span class="c1">// Correct our Kalman filter&#39;s state vector estimate with encoder data.</span>
<span class="linenos">104</span><span class="w">    </span><span class="n">m_loop</span><span class="p">.</span><span class="n">Correct</span><span class="p">(</span><span class="n">frc</span><span class="o">::</span><span class="n">Vectord</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span><span class="n">m_encoder</span><span class="p">.</span><span class="n">GetRate</span><span class="p">()});</span><span class="w"></span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="w">    </span><span class="c1">// Update our LQR to generate new voltage commands and use the voltages to</span>
<span class="linenos">107</span><span class="w">    </span><span class="c1">// predict the next state with out Kalman filter.</span>
<span class="linenos">108</span><span class="w">    </span><span class="n">m_loop</span><span class="p">.</span><span class="n">Predict</span><span class="p">(</span><span class="mi">20</span><span class="n">_ms</span><span class="p">);</span><span class="w"></span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="w">    </span><span class="c1">// Send the new calculated voltage to the motors.</span>
<span class="linenos">111</span><span class="w">    </span><span class="c1">// voltage = duty cycle * battery voltage, so</span>
<span class="linenos">112</span><span class="w">    </span><span class="c1">// duty cycle = voltage / battery voltage</span>
<span class="linenos">113</span><span class="w">    </span><span class="n">m_motor</span><span class="p">.</span><span class="n">SetVoltage</span><span class="p">(</span><span class="n">units</span><span class="o">::</span><span class="n">volt_t</span><span class="p">{</span><span class="n">m_loop</span><span class="p">.</span><span class="n">U</span><span class="p">(</span><span class="mi">0</span><span class="p">)});</span><span class="w"></span>
<span class="linenos">114</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></div>
</section>
<section id="angle-wrap-with-lqr">
<h2>Angle Wrap with LQR<a class="headerlink" href="#angle-wrap-with-lqr" title="Permalink to this heading"></a></h2>
<p>Mechanisms with a continuous angle can have that angle wrapped by calling the code below instead of <code class="docutils literal notranslate"><span class="pre">lqr.Calculate(x,</span> <span class="pre">r)</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-SmF2YQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-6-SmF2YQ==" name="SmF2YQ==" role="tab" tabindex="0">Java</button><button aria-controls="panel-6-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-6-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-6-SmF2YQ==" class="sphinx-tabs-panel group-tab" id="panel-6-SmF2YQ==" name="SmF2YQ==" role="tabpanel" tabindex="0"><div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lqr</span><span class="p">.</span><span class="na">getR</span><span class="p">().</span><span class="na">minus</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="n">error</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MathUtil</span><span class="p">.</span><span class="na">angleModulus</span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lqr</span><span class="p">.</span><span class="na">getK</span><span class="p">().</span><span class="na">times</span><span class="p">(</span><span class="n">error</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-6-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-6-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lqr</span><span class="p">.</span><span class="n">R</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="n">error</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frc</span><span class="o">::</span><span class="n">AngleModulus</span><span class="p">(</span><span class="n">units</span><span class="o">::</span><span class="n">radian_t</span><span class="p">{</span><span class="n">error</span><span class="p">(</span><span class="mi">0</span><span class="p">)}).</span><span class="n">value</span><span class="p">();</span><span class="w"></span>
<span class="n">Eigen</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lqr</span><span class="p">.</span><span class="n">K</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">error</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div></div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="state-space-intro.html" class="btn btn-neutral float-left" title="Introduction to State-Space Control" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="state-space-observers.html" class="btn btn-neutral float-right" title="State Observers and Kalman Filters" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, FIRST and other WPILib Contributors. This work is licensed under a Creative Commons Attribution 4.0 International License.
      <span class="commit">Revision <code>c3ff9f30</code>.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="Versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
          <dd><a href="/en/stable/">stable</a></dd>
        
          <dd><a href="/en/2022/">2022</a></dd>
        
          <dd><a href="/en/2021/">2021</a></dd>
        
          <dd><a href="/en/2020/">2020</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="//docs.wpilib.org/_/downloads/en/latest/pdf/">pdf</a></dd>
        
          <dd><a href="//docs.wpilib.org/_/downloads/en/latest/htmlzip/">html</a></dd>
        
      </dl>
      <dl>
        
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/frc-docs/?fromdocs=frc-docs">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/frc-docs/?fromdocs=frc-docs">Builds</a>
          </dd>
      </dl>
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>
  <script>
    if (typeof READTHEDOCS_DATA !== 'undefined') {
        if (!READTHEDOCS_DATA.features) {
          READTHEDOCS_DATA.features = {};
        }
        READTHEDOCS_DATA.features.docsearch_disabled = false;
      }
    </script>

</body>
</html>